<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reportes Ciudadanos - Quito</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background-color: #2c3e50;
            color: white;
            padding: 20px 0;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
        }
        
        header p {
            font-size: 1rem;
            opacity: 0.9;
        }
        
        .form-container {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            overflow: hidden;
            margin-bottom: 30px;
        }
        
        .progress-bar {
            display: flex;
            background-color: #ecf0f1;
            height: 10px;
        }
        
        .progress-step {
            flex: 1;
            height: 100%;
            background-color: #bdc3c7;
            transition: background-color 0.3s;
        }
        
        .progress-step.active {
            background-color: #27ae60;
        }
        
        .form-steps {
            padding: 30px;
        }
        
        .form-step {
            display: none;
            animation: fadeIn 0.5s ease;
        }
        
        .form-step.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #2c3e50;
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            transition: border 0.3s;
        }
        
        .form-control:focus {
            border-color: #27ae60;
            outline: none;
        }
        
        textarea.form-control {
            min-height: 120px;
            resize: vertical;
        }
        
        .btn {
            display: inline-block;
            padding: 12px 25px;
            background-color: #27ae60;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            text-align: center;
        }
        
        .btn:hover {
            background-color: #219653;
        }
        
        .btn-outline {
            background-color: transparent;
            border: 1px solid #3498db;
            color: #3498db;
        }
        
        .btn-outline:hover {
            background-color: #f8f9fa;
        }
        
        .btn-secondary {
            background-color: #3498db;
        }
        
        .btn-secondary:hover {
            background-color: #2980b9;
        }
        
        .step-navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
        }
        
        .category-options {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .category-option {
            padding: 20px;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        
        .category-option:hover {
            border-color: #27ae60;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .category-option.selected {
            border-color: #27ae60;
            background-color: #e8f5e9;
        }
        
        .category-icon {
            font-size: 2rem;
            margin-bottom: 10px;
            color: #27ae60;
        }
        
        .subcategory-options {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
        }
        
        .subcategory-option {
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .subcategory-option:hover {
            border-color: #27ae60;
            background-color: #f8f9fa;
        }
        
        .subcategory-option.selected {
            border-color: #27ae60;
            background-color: #e8f5e9;
        }
        
        #map-container {
            height: 400px;
            width: 100%;
            border-radius: 8px;
            overflow: hidden;
            margin-top: 20px;
            border: 1px solid #ddd;
        }
        
        #map {
            height: 100%;
            width: 100%;
            transition: opacity 0.3s;
        }
        
        #map.leaflet-container {
            opacity: 1;
        }
        
        #reports-map-container {
            height: 500px;
            border-radius: 8px;
            overflow: hidden;
            margin-top: 20px;
            border: 1px solid #ddd;
        }
        
        #reports-map {
            height: 100%;
            width: 100%;
        }
        
        .location-info {
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 6px;
            margin-top: 15px;
            border: 1px solid #eee;
            display: none;
        }
        
        .confirmation-message {
            padding: 20px;
            background-color: #d4edda;
            color: #155724;
            border-radius: 6px;
            margin-bottom: 20px;
        }
        
        .report-summary {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 6px;
            margin-bottom: 20px;
        }
        
        .report-summary p {
            margin-bottom: 10px;
        }
        
        .report-summary strong {
            color: #2c3e50;
        }
        
        .form-hint {
            font-size: 0.85rem;
            color: #7f8c8d;
            margin-top: 5px;
        }
        
        .required-field::after {
            content: " *";
            color: #e74c3c;
        }
        
        .map-legend {
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            line-height: 1.5;
            font-size: 0.9rem;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            margin-right: 8px;
            border-radius: 50%;
        }
        
        .reports-container {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 30px;
        }
        
        .view-toggle {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }
        
        .view-toggle button {
            margin: 0 10px;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
        }
        
        .view-toggle button.active {
            background-color: #2c3e50;
            color: white;
        }
        
        /* Estilos para el dashboard de estadísticas */
        .stats-dashboard {
            margin-top: 30px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            padding: 20px;
        }
        
        .stats-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .stats-title {
            font-size: 1.5rem;
            color: #2c3e50;
        }
        
        .refresh-btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .refresh-btn:hover {
            background-color: #2980b9;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        
        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: #2c3e50;
            margin: 10px 0;
        }
        
        .stat-label {
            font-size: 1rem;
            color: #7f8c8d;
        }
        
        .stat-icon {
            font-size: 2rem;
            color: #3498db;
        }
        
        .charts-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        .chart-card {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .chart-title {
            font-size: 1.2rem;
            color: #2c3e50;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .chart-placeholder {
            height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f8f9fa;
            border-radius: 5px;
            color: #7f8c8d;
        }
        
        .recent-reports {
            margin-top: 30px;
        }
        
        .reports-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .reports-table th, .reports-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        .reports-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .reports-table tr:hover {
            background-color: #f1f5f9;
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .status-pendiente {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .status-en-proceso {
            background-color: #cce5ff;
            color: #004085;
        }
        
        .status-resuelto {
            background-color: #d4edda;
            color: #155724;
        }
        
        @media (max-width: 768px) {
            .category-options {
                grid-template-columns: 1fr;
            }
            
            .container {
                padding: 10px;
            }
            
            .form-steps {
                padding: 20px;
            }
            
            #reports-map-container {
                height: 400px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .charts-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1><i class="fas fa-map-marked-alt"></i> Reportes Ciudadanos - Quito</h1>
            <p>Reporta problemas en tu barrio o comunidad</p>
        </div>
    </header>
    
    <div class="container">
        <div class="view-toggle">
            <button id="view-reports-btn" class="active">Ver Reportes</button>
            <button id="new-report-btn">Nuevo Reporte</button>
        </div>
        
        <div class="reports-container" id="reports-view">
            <h2><i class="fas fa-map"></i> Reportes Ciudadanos</h2>
            <p>Visualiza los reportes existentes en el mapa:</p>
            <div id="reports-map-container">
                <div id="reports-map"></div>
            </div>
            
            <!-- Dashboard de estadísticas -->
            <div class="stats-dashboard">
                <div class="stats-header">
                    <h2 class="stats-title"><i class="fas fa-chart-line"></i> Estadísticas de Reportes</h2>
                    <button class="refresh-btn" id="refresh-stats"><i class="fas fa-sync-alt"></i> Actualizar</button>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-file-alt"></i></div>
                        <div class="stat-value" id="total-reports">0</div>
                        <div class="stat-label">Reportes Totales</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-clock"></i></div>
                        <div class="stat-value" id="pending-reports">0</div>
                        <div class="stat-label">Pendientes</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-spinner"></i></div>
                        <div class="stat-value" id="in-progress-reports">0</div>
                        <div class="stat-label">En Proceso</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-check-circle"></i></div>
                        <div class="stat-value" id="resolved-reports">0</div>
                        <div class="stat-label">Resueltos</div>
                    </div>
                </div>
                
                <div class="charts-container">
                    <div class="chart-card">
                        <h3 class="chart-title">Reportes por Categoría</h3>
                        <div class="chart-placeholder" id="category-chart">
                            <canvas id="categoryChartCanvas"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-card">
                        <h3 class="chart-title">Reportes por Estado</h3>
                        <div class="chart-placeholder" id="status-chart">
                            <canvas id="statusChartCanvas"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="recent-reports">
                    <h3><i class="fas fa-list"></i> Reportes Recientes</h3>
                    <div class="table-responsive">
                        <table class="reports-table">
                            <thead>
                                <tr>
                                    <th>Categoría</th>
                                    <th>Tipo</th>
                                    <th>Fecha</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody id="recent-reports-list">
                                <!-- Los reportes recientes se cargarán aquí -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="form-container" id="new-report-view" style="display: none;">
            <div class="progress-bar">
                <div class="progress-step" id="step-1-progress"></div>
                <div class="progress-step" id="step-2-progress"></div>
                <div class="progress-step" id="step-3-progress"></div>
                <div class="progress-step" id="step-4-progress"></div>
                <div class="progress-step" id="step-5-progress"></div>
            </div>
            
            <div class="form-steps">
                <!-- Paso 1: Selección de categoría -->
                <div class="form-step active" id="step-1">
                    <h2>1. Selecciona una categoría</h2>
                    <p>Elige el tipo de problema que deseas reportar:</p>
                    
                    <div class="category-options">
                        <div class="category-option" data-category="infraestructura_urbana">
                            <div class="category-icon"><i class="fas fa-road"></i></div>
                            <h3>Infraestructura Urbana</h3>
                            <p>Problemas con calles, aceras, semáforos y señalización</p>
                        </div>
                        
                        <div class="category-option" data-category="servicios_publicos">
                            <div class="category-icon"><i class="fas fa-tools"></i></div>
                            <h3>Servicios Públicos</h3>
                            <p>Fugas de agua, postes de luz, recolección de basura</p>
                        </div>
                        
                        <div class="category-option" data-category="seguridad_ciudadana">
                            <div class="category-icon"><i class="fas fa-shield-alt"></i></div>
                            <h3>Seguridad Ciudadana</h3>
                            <p>Robos, vandalismo, iluminación pública</p>
                        </div>
                        
                        <div class="category-option" data-category="emergencias_viales">
                            <div class="category-icon"><i class="fas fa-car-crash"></i></div>
                            <h3>Emergencias Viales</h3>
                            <p>Accidentes, vehículos abandonados, obstáculos</p>
                        </div>
                        
                        <div class="category-option" data-category="problemas_ambientales">
                            <div class="category-icon"><i class="fas fa-leaf"></i></div>
                            <h3>Problemas Ambientales</h3>
                            <p>Quemas, contaminación, tala de árboles, ruido</p>
                        </div>
                    </div>
                    
                    <div class="step-navigation">
                        <div></div> <!-- Espaciador -->
                        <button type="button" class="btn" id="next-1">Siguiente <i class="fas fa-arrow-right"></i></button>
                    </div>
                </div>
                
                <!-- Paso 2: Selección de subcategoría -->
                <div class="form-step" id="step-2">
                    <h2>2. Tipo específico de problema</h2>
                    <p>Selecciona el tipo específico del problema que deseas reportar:</p>
                    
                    <div class="form-group">
                        <div id="subcategory-options" class="subcategory-options"></div>
                    </div>
                    
                    <div class="step-navigation">
                        <button type="button" class="btn btn-outline" id="prev-2"><i class="fas fa-arrow-left"></i> Anterior</button>
                        <button type="button" class="btn" id="next-2">Siguiente <i class="fas fa-arrow-right"></i></button>
                    </div>
                </div>
                
                <!-- Paso 3: Información personal -->
                <div class="form-step" id="step-3">
                    <h2>3. Tus datos</h2>
                    <p>Por favor ingresa tu información de contacto (opcional pero recomendado):</p>
                    
                    <div class="form-group">
                        <label for="nombre" class="required-field">Nombre completo</label>
                        <input type="text" id="nombre" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="telefono">Número de contacto</label>
                        <input type="tel" id="telefono" class="form-control" placeholder="Ej: 0991234567">
                        <div class="form-hint">Este número será usado solo para contactarte sobre tu reporte</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="email">Correo electrónico</label>
                        <input type="email" id="email" class="form-control" placeholder="tucorreo@ejemplo.com">
                    </div>
                    
                    <div class="step-navigation">
                        <button type="button" class="btn btn-outline" id="prev-3"><i class="fas fa-arrow-left"></i> Anterior</button>
                        <button type="button" class="btn" id="next-3">Siguiente <i class="fas fa-arrow-right"></i></button>
                    </div>
                </div>
                
                <!-- Paso 4: Descripción del problema -->
                <div class="form-step" id="step-4">
                    <h2>4. Describe el problema</h2>
                    <p>Proporciona detalles sobre el problema que estás reportando:</p>
                    
                    <div class="form-group">
                        <label for="descripcion" class="required-field">Descripción detallada</label>
                        <textarea id="descripcion" class="form-control" required placeholder="Describe el problema con el mayor detalle posible..."></textarea>
                        <div class="form-hint">Incluye información como gravedad, tiempo que lleva el problema, etc.</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="foto">Subir foto (opcional)</label>
                        <input type="file" id="foto" class="form-control" accept="image/*">
                        <div class="form-hint">Máximo 5MB. Formatos: JPG, PNG</div>
                    </div>
                    
                    <div class="step-navigation">
                        <button type="button" class="btn btn-outline" id="prev-4"><i class="fas fa-arrow-left"></i> Anterior</button>
                        <button type="button" class="btn" id="next-4">Siguiente <i class="fas fa-arrow-right"></i></button>
                    </div>
                </div>
                
                <!-- Paso 5: Ubicación -->
                <div class="form-step" id="step-5">
                    <h2>5. Ubicación del problema</h2>
                    <p>Selecciona la ubicación exacta del problema en el mapa:</p>
                    
                    <div class="form-group">
                        <label for="direccion">Dirección aproximada</label>
                        <input type="text" id="direccion" class="form-control" placeholder="Ej: Av. Amazonas y Juan León Mera">
                    </div>
                    
                    <div id="map-container">
                        <div id="map"></div>
                    </div>
                    
                    <div class="location-info" id="ubicacion-info">
                        <i class="fas fa-map-marker-alt"></i> <span id="coordenadas-texto"></span>
                    </div>
                    <div class="form-hint">Haz clic en el mapa para marcar la ubicación exacta</div>
                    
                    <div class="step-navigation">
                        <button type="button" class="btn btn-outline" id="prev-5"><i class="fas fa-arrow-left"></i> Anterior</button>
                        <button type="button" class="btn" id="submit-reporte">Enviar Reporte <i class="fas fa-paper-plane"></i></button>
                    </div>
                </div>
                
                <!-- Paso 6: Confirmación -->
                <div class="form-step" id="step-6">
                    <h2><i class="fas fa-check-circle" style="color: #27ae60;"></i> Reporte enviado con éxito</h2>
                    
                    <div class="confirmation-message">
                        <p>¡Gracias por tu reporte! Hemos recibido la información y será procesada por las autoridades correspondientes.</p>
                        <p>Tu número de seguimiento es: <strong id="codigo-seguimiento">QUITO-<span id="random-code"></span></strong></p>
                    </div>
                    
                    <div class="report-summary">
                        <h3>Resumen del reporte</h3>
                        <div id="reporte-resumen"></div>
                    </div>
                    
                    <div class="step-navigation" style="justify-content: center;">
                        <button type="button" class="btn" id="new-reporte">
                            <i class="fas fa-plus"></i> Hacer otro reporte
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.38.4/dist/umd/supabase.min.js"></script>
    <script>
        // Variables globales
        let map;
        let reportsMap;
        let marker = null;
        let selectedCategory = null;
        let selectedSubcategory = null;
        let currentStep = 1;
        let markersLayer = L.layerGroup();
        let categoryChart = null;
        let statusChart = null;
        
        // Configuración de Supabase
        const supabaseUrl = 'https://dbshhxslvsvwmrcwxkls.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRic2hoeHNsdnN2d21yY3d4a2xzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI4MTExMzYsImV4cCI6MjA2ODM4NzEzNn0.O-TNkvxS0W8XLzkxNxIl2HYqRlib5MLM8_XW8JOEueo';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
        
        // Subcategorías para cada categoría
        const subcategories = {
            infraestructura_urbana: [
                'Baches en la vía',
                'Semáforos dañados',
                'Señalización faltante',
                'Aceras en mal estado',
                'Alcantarillas destapadas',
                'Puentes o pasos peatonales dañados'
            ],
            servicios_publicos: [
                'Fugas de agua potable',
                'Postes de luz dañados',
                'Cableado eléctrico peligroso',
                'Recolección de basura irregular',
                'Contenedores de basura llenos/dañados',
                'Problemas con alcantarillado'
            ],
            seguridad_ciudadana: [
                'Robos/asalos reportados',
                'Puntos de drogas',
                'Vandalismo',
                'Iluminación pública insuficiente',
                'Zonas peligrosas identificadas',
                'Personas sospechosas merodeando'
            ],
            emergencias_viales: [
                'Accidentes de tránsito',
                'Vehículos abandonados',
                'Obstáculos en la vía',
                'Conductor en estado de embriaguez',
                'Exceso de velocidad en zona escolar',
                'Animales sueltos en la vía'
            ],
            problemas_ambientales: [
                'Quemas ilegales',
                'Contaminación de quebradas',
                'Tala de árboles',
                'Acumulación de escombros',
                'Ruido excesivo (bares, industrias)',
                'Malos olores o contaminación del aire'
            ]
        };
        
        // Colores para cada categoría en el mapa
        const categoryColors = {
            infraestructura_urbana: '#e74c3c',  // Rojo
            servicios_publicos: '#3498db',      // Azul
            seguridad_ciudadana: '#f39c12',     // Naranja
            emergencias_viales: '#9b59b6',      // Morado
            problemas_ambientales: '#2ecc71'    // Verde
        };
        
        // Inicialización del mapa de reportes (centrado en Ecuador)
        function initReportsMap() {
            // Coordenadas centrales de Ecuador y zoom para ver todo el país
            const ecuadorCenter = [-1.8312, -78.1834];
            const zoomLevel = 6;
            
            // Crear mapa
            reportsMap = L.map('reports-map').setView(ecuadorCenter, zoomLevel);
            
            // Añadir capa base
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            }).addTo(reportsMap);
            
            // Añadir capa de marcadores
            markersLayer.addTo(reportsMap);
            
            // Añadir leyenda
            const legend = L.control({position: 'bottomright'});
            
            legend.onAdd = function() {
                const div = L.DomUtil.create('div', 'map-legend');
                let labels = ['<strong>Categorías</strong>'];
                
                for (const category in categoryColors) {
                    labels.push(
                        `<div class="legend-item">
                            <div class="legend-color" style="background:${categoryColors[category]}"></div>
                            <span>${getCategoryName(category)}</span>
                        </div>`
                    );
                }
                
                div.innerHTML = labels.join('');
                return div;
            };
            
            legend.addTo(reportsMap);
            
            // Cargar reportes existentes
            loadExistingReports();
        }
        
        // Inicialización del mapa para nuevo reporte (centrado en Quito)
        function initNewReportMap() {
            // Solo inicializar si no existe ya
            if (map) {
                // Si el mapa ya existe, solo redimensionarlo
                setTimeout(() => {
                    map.invalidateSize();
                }, 100);
                return;
            }
            
            // Coordenadas del centro de Quito
            const quitoCenter = [-0.2295, -78.5249];
            const zoomLevel = 12;
            
            // Crear mapa
            map = L.map('map').setView(quitoCenter, zoomLevel);
            
            // Añadir capa base
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            }).addTo(map);
            
            // Evento para hacer clic en el mapa
            map.on('click', function(e) {
                setLocation(e.latlng);
            });
            
            // Asegurar que el mapa se redibuje correctamente
            setTimeout(() => {
                map.invalidateSize();
            }, 100);
        }
        
        // Cargar reportes existentes desde Supabase
        async function loadExistingReports() {
            markersLayer.clearLayers();
            
            const tablas = Object.keys(subcategories);
            let allReports = [];
            let totalReports = 0;
            let pendingReports = 0;
            let inProgressReports = 0;
            let resolvedReports = 0;
            
            for (const tabla of tablas) {
                const { data, error } = await supabase.from(tabla).select('*');
                
                if (error) {
                    console.error(`Error cargando ${tabla}:`, error.message);
                    continue;
                }
                
                if (data) {
                    // Procesar datos para estadísticas
                    data.forEach(reporte => {
                        reporte.categoria = tabla;
                        allReports.push(reporte);
                        
                        // Contar por estado
                        if (reporte.estado === 'pendiente') pendingReports++;
                        else if (reporte.estado === 'en_proceso') inProgressReports++;
                        else if (reporte.estado === 'resuelto') resolvedReports++;
                    });
                    
                    totalReports += data.length;
                    
                    // Añadir marcadores al mapa
                    data.forEach(reporte => {
                        if (reporte.geom && reporte.geom.coordinates) {
                            const coords = reporte.geom.coordinates;
                            const marker = L.circleMarker([coords[1], coords[0]], {
                                color: categoryColors[tabla],
                                radius: 6,
                                fillOpacity: 0.7
                            }).addTo(markersLayer);
                            
                            let popupContent = `<strong>${getCategoryName(tabla)}</strong>`;
                            if (reporte.subcategoria) popupContent += `<br><em>${reporte.subcategoria}</em>`;
                            if (reporte.descripcion) popupContent += `<br>${reporte.descripcion}`;
                            if (reporte.fecha_reporte) popupContent += `<br><small>Reportado el ${new Date(reporte.fecha_reporte).toLocaleDateString()}</small>`;
                            
                            marker.bindPopup(popupContent);
                        }
                    });
                }
            }
            
            // Actualizar estadísticas
            updateStats(totalReports, pendingReports, inProgressReports, resolvedReports);
            
            // Actualizar gráficos
            updateCharts(allReports);
            
            // Mostrar reportes recientes
            showRecentReports(allReports);
        }
        
        // Actualizar las estadísticas en el dashboard
        function updateStats(total, pending, inProgress, resolved) {
            document.getElementById('total-reports').textContent = total;
            document.getElementById('pending-reports').textContent = pending;
            document.getElementById('in-progress-reports').textContent = inProgress;
            document.getElementById('resolved-reports').textContent = resolved;
        }
        
        // Actualizar los gráficos
        function updateCharts(reports) {
            // Destruir gráficos existentes si los hay
            if (categoryChart) categoryChart.destroy();
            if (statusChart) statusChart.destroy();
            
            // Preparar datos para gráfico de categorías
            const categories = Object.keys(subcategories);
            const categoryCounts = {};
            
            categories.forEach(cat => {
                categoryCounts[cat] = reports.filter(r => r.categoria === cat).length;
            });
            
            // Gráfico de categorías
            const categoryCtx = document.getElementById('categoryChartCanvas').getContext('2d');
            categoryChart = new Chart(categoryCtx, {
                type: 'bar',
                data: {
                    labels: categories.map(cat => getCategoryName(cat)),
                    datasets: [{
                        label: 'Reportes por Categoría',
                        data: categories.map(cat => categoryCounts[cat]),
                        backgroundColor: categories.map(cat => categoryColors[cat]),
                        borderColor: categories.map(cat => darkenColor(categoryColors[cat], 20)),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
            
            // Preparar datos para gráfico de estados
            const statusData = {
                pendiente: reports.filter(r => r.estado === 'pendiente').length,
                en_proceso: reports.filter(r => r.estado === 'en_proceso').length,
                resuelto: reports.filter(r => r.estado === 'resuelto').length
            };
            
            // Gráfico de estados
            const statusCtx = document.getElementById('statusChartCanvas').getContext('2d');
            statusChart = new Chart(statusCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Pendientes', 'En Proceso', 'Resueltos'],
                    datasets: [{
                        data: [statusData.pendiente, statusData.en_proceso, statusData.resuelto],
                        backgroundColor: [
                            '#fff3cd',
                            '#cce5ff',
                            '#d4edda'
                        ],
                        borderColor: [
                            '#ffe8a1',
                            '#99caff',
                            '#b1dfbb'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }
        
        // Mostrar reportes recientes
        function showRecentReports(reports) {
            // Ordenar reportes por fecha (más recientes primero)
            const sortedReports = [...reports].sort((a, b) => {
                return new Date(b.fecha_reporte) - new Date(a.fecha_reporte);
            });
            
            // Tomar los 10 más recientes
            const recentReports = sortedReports.slice(0, 10);
            
            // Generar HTML para la tabla
            const tableBody = document.getElementById('recent-reports-list');
            tableBody.innerHTML = '';
            
            recentReports.forEach(report => {
                const row = document.createElement('tr');
                
                // Categoría
                const categoryCell = document.createElement('td');
                categoryCell.textContent = getCategoryName(report.categoria);
                
                // Subcategoría
                const subcategoryCell = document.createElement('td');
                subcategoryCell.textContent = report.subcategoria || 'No especificado';
                
                // Fecha
                const dateCell = document.createElement('td');
                dateCell.textContent = new Date(report.fecha_reporte).toLocaleDateString();
                
                // Estado
                const statusCell = document.createElement('td');
                const statusBadge = document.createElement('span');
                statusBadge.className = 'status-badge';
                
                if (report.estado === 'pendiente') {
                    statusBadge.className += ' status-pendiente';
                    statusBadge.textContent = 'Pendiente';
                } else if (report.estado === 'en_proceso') {
                    statusBadge.className += ' status-en-proceso';
                    statusBadge.textContent = 'En Proceso';
                } else if (report.estado === 'resuelto') {
                    statusBadge.className += ' status-resuelto';
                    statusBadge.textContent = 'Resuelto';
                } else {
                    statusBadge.textContent = report.estado || 'No especificado';
                }
                
                statusCell.appendChild(statusBadge);
                
                // Añadir celdas a la fila
                row.appendChild(categoryCell);
                row.appendChild(subcategoryCell);
                row.appendChild(dateCell);
                row.appendChild(statusCell);
                
                // Añadir fila a la tabla
                tableBody.appendChild(row);
            });
        }
        
        // Función para oscurecer un color (usado en gráficos)
        function darkenColor(color, percent) {
            const num = parseInt(color.replace("#", ""), 16),
                amt = Math.round(2.55 * percent),
                R = (num >> 16) - amt,
                G = (num >> 8 & 0x00FF) - amt,
                B = (num & 0x0000FF) - amt;
            
            return "#" + (
                0x1000000 +
                (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
                (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
                (B < 255 ? B < 1 ? 0 : B : 255)
            ).toString(16).slice(1);
        }
        
        // Establecer ubicación seleccionada
        function setLocation(latlng) {
            // Eliminar marcador anterior si existe
            if (marker) {
                map.removeLayer(marker);
            }
            
            // Crear nuevo marcador
            marker = L.marker(latlng, {
                icon: L.divIcon({
                    className: 'custom-marker',
                    html: '<i class="fas fa-map-marker-alt" style="color: #e74c3c; font-size: 32px;"></i>',
                    iconSize: [32, 32],
                    iconAnchor: [16, 32]
                })
            }).addTo(map);
            
            // Actualizar información de ubicación
            document.getElementById('coordenadas-texto').textContent = 
                `${latlng.lat.toFixed(6)}, ${latlng.lng.toFixed(6)}`;
            document.getElementById('ubicacion-info').style.display = 'block';
        }
        
        // Cargar subcategorías según la categoría seleccionada
        function loadSubcategories() {
            const container = document.getElementById('subcategory-options');
            container.innerHTML = '';
            
            if (!selectedCategory) return;
            
            subcategories[selectedCategory].forEach(subcat => {
                const option = document.createElement('div');
                option.className = 'subcategory-option';
                option.textContent = subcat;
                option.dataset.subcategory = subcat;
                
                option.addEventListener('click', function() {
                    // Deseleccionar todas las opciones
                    document.querySelectorAll('#subcategory-options .subcategory-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    
                    // Seleccionar esta opción
                    this.classList.add('selected');
                    selectedSubcategory = this.dataset.subcategory;
                });
                
                container.appendChild(option);
            });
        }
        
        // Navegación entre pasos
        function goToStep(step) {
            // Validar antes de avanzar
            if (step > currentStep) {
                if (currentStep === 1 && !selectedCategory) {
                    alert('Por favor selecciona una categoría');
                    return;
                }
                
                if (currentStep === 2 && !selectedSubcategory) {
                    alert('Por favor selecciona un tipo de problema');
                    return;
                }
                
                if (currentStep === 3) {
                    const nombre = document.getElementById('nombre').value;
                    if (!nombre) {
                        alert('Por favor ingresa tu nombre');
                        return;
                    }
                }
                
                if (currentStep === 4) {
                    const descripcion = document.getElementById('descripcion').value;
                    if (!descripcion) {
                        alert('Por favor describe el problema');
                        return;
                    }
                }
            }
            
            // Ocultar paso actual
            document.getElementById(`step-${currentStep}`).classList.remove('active');
            
            // Actualizar paso actual
            currentStep = step;
            
            // Mostrar nuevo paso
            document.getElementById(`step-${currentStep}`).classList.add('active');
            
            // Actualizar barra de progreso
            updateProgressBar();
            
            // Configurar paso específico
            if (currentStep === 2) {
                loadSubcategories();
            }
            
            if (currentStep === 5) {
                // Inicializar el mapa solo cuando llegamos al paso 5
                initNewReportMap();
            }
            
            if (currentStep === 6) {
                showConfirmation();
            }
        }
        
        // Actualizar barra de progreso
        function updateProgressBar() {
            for (let i = 1; i <= 5; i++) {
                const stepElement = document.getElementById(`step-${i}-progress`);
                if (i < currentStep) {
                    stepElement.classList.add('active');
                } else if (i === currentStep) {
                    stepElement.classList.add('active');
                } else {
                    stepElement.classList.remove('active');
                }
            }
        }
        
        // Mostrar confirmación
        function showConfirmation() {
            // Generar código aleatorio
            const randomCode = Math.floor(100000 + Math.random() * 900000);
            document.getElementById('random-code').textContent = randomCode;
            
            // Mostrar resumen
            const nombre = document.getElementById('nombre').value || 'No proporcionado';
            const telefono = document.getElementById('telefono').value || 'No proporcionado';
            const descripcion = document.getElementById('descripcion').value;
            const direccion = document.getElementById('direccion').value || 'No especificada';
            const coords = document.getElementById('coordenadas-texto').textContent || 'No seleccionada';
            
            const resumenHTML = `
                <p><strong>Categoría:</strong> ${getCategoryName(selectedCategory)}</p>
                <p><strong>Tipo de problema:</strong> ${selectedSubcategory}</p>
                <p><strong>Descripción:</strong> ${descripcion}</p>
                <p><strong>Dirección:</strong> ${direccion}</p>
                <p><strong>Ubicación exacta:</strong> ${coords}</p>
                <p><strong>Reportado por:</strong> ${nombre} (${telefono})</p>
                <p><strong>Fecha y hora:</strong> ${new Date().toLocaleString()}</p>
            `;
            
            document.getElementById('reporte-resumen').innerHTML = resumenHTML;
            
            // Enviar datos a Supabase
            enviarReporteASupabase();
        }
        
        // Enviar reporte a Supabase
        async function enviarReporteASupabase() {
            if (!selectedCategory || !marker) return;
            
            const reportData = {
                subcategoria: selectedSubcategory,
                nombre_reportero: document.getElementById('nombre').value || null,
                telefono_reportero: document.getElementById('telefono').value || null,
                email_reportero: document.getElementById('email').value || null,
                descripcion: document.getElementById('descripcion').value,
                direccion: document.getElementById('direccion').value || null,
                geom: {
                    type: 'Point',
                    coordinates: [marker.getLatLng().lng, marker.getLatLng().lat]
                },
                fecha_reporte: new Date().toISOString(),
                estado: 'pendiente'
            };
            
            try {
                // Manejar la foto si se subió
                const fotoInput = document.getElementById('foto');
                if (fotoInput.files.length > 0) {
                    const file = fotoInput.files[0];
                    const fileName = `${selectedCategory}_${Date.now()}_${file.name}`;
                    
                    // Subir la foto al almacenamiento
                    const { data: uploadData, error: uploadError } = await supabase.storage
                        .from('reportes-fotos')
                        .upload(fileName, file);
                    
                    if (!uploadError) {
                        // Obtener URL pública de la foto
                        const { data: urlData } = supabase.storage
                            .from('reportes-fotos')
                            .getPublicUrl(fileName);
                        
                        reportData.foto_url = urlData.publicUrl;
                    } else {
                        console.error('Error al subir foto:', uploadError);
                    }
                }
                
                // Insertar en la tabla correspondiente
                const { data, error } = await supabase
                    .from(selectedCategory)
                    .insert([reportData])
                    .select();
                
                if (error) {
                    console.error('Error al enviar reporte:', error);
                    alert('Hubo un error al enviar tu reporte. Por favor intenta nuevamente.');
                } else {
                    console.log('Reporte enviado con éxito:', data);
                    // Actualizar el mapa de reportes
                    loadExistingReports();
                }
            } catch (err) {
                console.error('Error en el proceso de envío:', err);
                alert('Ocurrió un error inesperado. Por favor intenta nuevamente.');
            }
        }
        
        // Obtener nombre completo de categoría
        function getCategoryName(categoryKey) {
            const names = {
                infraestructura_urbana: 'Infraestructura Urbana',
                servicios_publicos: 'Servicios Públicos',
                seguridad_ciudadana: 'Seguridad Ciudadana',
                emergencias_viales: 'Emergencias Viales',
                problemas_ambientales: 'Problemas Ambientales'
            };
            return names[categoryKey] || categoryKey;
        }
        
        // Reiniciar formulario
        function resetForm() {
            // Resetear selecciones
            selectedCategory = null;
            selectedSubcategory = null;
            
            // Deseleccionar opciones
            document.querySelectorAll('.category-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            
            document.querySelectorAll('.subcategory-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            
            // Limpiar campos
            document.getElementById('nombre').value = '';
            document.getElementById('telefono').value = '';
            document.getElementById('email').value = '';
            document.getElementById('descripcion').value = '';
            document.getElementById('direccion').value = '';
            document.getElementById('foto').value = '';
            
            // Ocultar ubicación
            document.getElementById('ubicacion-info').style.display = 'none';
            
            // Eliminar marcador del mapa
            if (marker) {
                map.removeLayer(marker);
                marker = null;
            }
            
            // Volver al paso 1
            goToStep(1);
        }
        
        // Cambiar entre vistas (reportes/nuevo reporte)
        function toggleView(view) {
            if (view === 'reports') {
                document.getElementById('reports-view').style.display = 'block';
                document.getElementById('new-report-view').style.display = 'none';
                document.getElementById('view-reports-btn').classList.add('active');
                document.getElementById('new-report-btn').classList.remove('active');
                
                // Asegurar que el mapa de reportes se redibuje correctamente
                setTimeout(() => {
                    if (reportsMap) reportsMap.invalidateSize();
                }, 100);
            } else {
                document.getElementById('reports-view').style.display = 'none';
                document.getElementById('new-report-view').style.display = 'block';
                document.getElementById('view-reports-btn').classList.remove('active');
                document.getElementById('new-report-btn').classList.add('active');
                
                // Asegurar que el mapa del formulario se redibuje correctamente
                setTimeout(() => {
                    if (map) map.invalidateSize();
                }, 100);
            }
        }
        
        // Eventos al cargar la página
        document.addEventListener('DOMContentLoaded', function() {
            // Inicializar solo el mapa de reportes
            initReportsMap();
            
            // Configurar botones de vista
            document.getElementById('view-reports-btn').addEventListener('click', () => toggleView('reports'));
            document.getElementById('new-report-btn').addEventListener('click', () => toggleView('new-report'));
            
            // Botón para actualizar estadísticas
            document.getElementById('refresh-stats').addEventListener('click', () => {
                loadExistingReports();
            });
            
            // Mostrar vista de reportes por defecto
            toggleView('reports');
            
            // Selección de categoría
            document.querySelectorAll('.category-option').forEach(option => {
                option.addEventListener('click', function() {
                    // Deseleccionar todas las opciones
                    document.querySelectorAll('.category-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    
                    // Seleccionar esta opción
                    this.classList.add('selected');
                    selectedCategory = this.dataset.category;
                });
            });
            
            // Navegación entre pasos
            document.getElementById('next-1').addEventListener('click', () => goToStep(2));
            document.getElementById('next-2').addEventListener('click', () => goToStep(3));
            document.getElementById('next-3').addEventListener('click', () => goToStep(4));
            document.getElementById('next-4').addEventListener('click', () => goToStep(5));
            
            document.getElementById('prev-2').addEventListener('click', () => goToStep(1));
            document.getElementById('prev-3').addEventListener('click', () => goToStep(2));
            document.getElementById('prev-4').addEventListener('click', () => goToStep(3));
            document.getElementById('prev-5').addEventListener('click', () => goToStep(4));
            
            // Enviar reporte
            document.getElementById('submit-reporte').addEventListener('click', function(e) {
                e.preventDefault();
                
                // Validar ubicación
                if (!marker) {
                    alert('Por favor selecciona una ubicación en el mapa');
                    return;
                }
                
                // Ir a paso de confirmación
                goToStep(6);
            });
            
            // Nuevo reporte
            document.getElementById('new-reporte').addEventListener('click', function() {
                resetForm();
                toggleView('new-report');
            });
            
            // Actualizar barra de progreso inicial
            updateProgressBar();
        });
    </script>
</body>
</html>
