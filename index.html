<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geoportal Supabase</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; }
        #map { height: 100vh; width: 100%; }
        
        /* Panel de control */
        .control-panel {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            width: 300px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        /* Pestañas */
        .tabs { display: flex; margin-bottom: 15px; }
        .tab-btn {
            padding: 8px 15px;
            background: #f0f0f0;
            border: none;
            border-radius: 5px 5px 0 0;
            cursor: pointer;
            margin-right: 5px;
            font-weight: 600;
        }
        .tab-btn.active {
            background: #4CAF50;
            color: white;
        }
        
        /* Contenido de pestañas */
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* Formulario */
        .form-group { margin-bottom: 12px; }
        label { display: block; margin-bottom: 5px; font-weight: 500; }
        input, select, textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            font-weight: 600;
        }
        button:hover { background: #45a049; }
        
        /* Capas */
        .layer-control { margin: 8px 0; }
        
        /* Estilos para marcadores */
        .parque-marker { background: #2ecc71; border-radius: 50%; }
        .eje-marker { background: #e74c3c; border-radius: 50%; }
        .report-marker { background: #9b59b6; border-radius: 50%; }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <div class="control-panel">
        <h1><i class="fas fa-map-marked-alt"></i> Geoportal</h1>
        
        <div class="tabs">
            <button class="tab-btn active" data-tab="layers"><i class="fas fa-layer-group"></i> Capas</button>
            <button class="tab-btn" data-tab="report"><i class="fas fa-plus-circle"></i> Reportar</button>
        </div>
        
        <!-- Pestaña de Capas -->
        <div id="layers-tab" class="tab-content active">
            <h3><i class="fas fa-filter"></i> Filtros</h3>
            <div class="layer-control">
                <input type="checkbox" id="ejes-viales" checked>
                <label for="ejes-viales">Ejes Viales</label>
            </div>
            <div class="layer-control">
                <input type="checkbox" id="parques" checked>
                <label for="parques">Parques</label>
            </div>
            <div class="layer-control">
                <input type="checkbox" id="paradas" checked>
                <label for="paradas">Paradas de Estación</label>
            </div>
            <div class="layer-control">
                <input type="checkbox" id="rural" checked>
                <label for="rural">Áreas Rurales</label>
            </div>
            <div class="layer-control">
                <input type="checkbox" id="urbana" checked>
                <label for="urbana">Áreas Urbanas</label>
            </div>
            <div class="layer-control">
                <input type="checkbox" id="reportes" checked>
                <label for="reportes">Reportes</label>
            </div>
        </div>
        
        <!-- Pestaña de Reportes -->
        <div id="report-tab" class="tab-content">
            <h3><i class="fas fa-edit"></i> Nuevo Reporte</h3>
            <div class="form-group">
                <label for="tipo-reporte">Tipo</label>
                <select id="tipo-reporte">
                    <option value="daño">Daño en infraestructura</option>
                    <option value="seguridad">Problema de seguridad</option>
                    <option value="mantenimiento">Necesidad de mantenimiento</option>
                    <option value="otro">Otro</option>
                </select>
            </div>
            <div class="form-group">
                <label for="descripcion">Descripción</label>
                <textarea id="descripcion" rows="3" placeholder="Describa el problema..."></textarea>
            </div>
            <button id="enviar-reporte"><i class="fas fa-paper-plane"></i> Enviar Reporte</button>
            <div id="mensaje-estado" style="margin-top:10px; display:none;"></div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Supabase JS -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <script>
        // ================= CONFIGURACIÓN =================
        const supabaseUrl = 'https://dbshhxslvsvwmrcwxkls.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRic2hoeHNsdnN2d21yY3d4a2xzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI4MTExMzYsImV4cCI6MjA2ODM4NzEzNn0.O-TNkvxS0W8XLzkxNxIl2HYqRlib5MLM8_XW8JOEueo';
        const supabase = supabase.createClient(supabaseUrl, supabaseKey);
        
        // Variables globales
        let map;
        let capas = {
            ejes_viales: null,
            parques: null,
            parada_estacion: null,
            parr_rural_conali_a: null,
            parr_urbana_ord002_a: null,
            reportes: null
        };
        let coordenadasActuales = null;
        
        // ================= INICIALIZACIÓN =================
        function initMap() {
            // Crear mapa centrado en Bogotá
            map = L.map('map').setView([4.6097, -74.0817], 13);
            
            // Añadir capa base de OpenStreetMap
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            }).addTo(map);
            
            // Cargar capas desde Supabase
            cargarCapas();
            
            // Configurar eventos
            configurarEventos();
        }
        
        // ================= CARGA DE CAPAS =================
        async function cargarCapas() {
            try {
                // 1. Cargar ejes viales (líneas)
                const { data: ejesData } = await supabase.from('ejes_viales').select('*');
                if (ejesData) {
                    capas.ejes_viales = L.geoJSON(ejesData, {
                        style: { color: '#e74c3c', weight: 3 }
                    }).addTo(map);
                }
                
                // 2. Cargar parques (polígonos)
                const { data: parquesData } = await supabase.from('parques').select('*');
                if (parquesData) {
                    capas.parques = L.geoJSON(parquesData, {
                        style: { 
                            color: '#2ecc71', 
                            fillColor: '#27ae60', 
                            fillOpacity: 0.5, 
                            weight: 2 
                        }
                    }).addTo(map);
                }
                
                // 3. Cargar paradas de estación (puntos)
                const { data: paradasData } = await supabase.from('parada_estacion').select('*');
                if (paradasData) {
                    capas.parada_estacion = L.geoJSON(paradasData, {
                        pointToLayer: (feature, latlng) => {
                            return L.circleMarker(latlng, {
                                radius: 6,
                                color: '#3498db',
                                fillColor: '#2980b9',
                                className: 'parada-marker'
                            }).bindPopup(`<b>Parada:</b> ${feature.properties?.nombre || 'N/A'}`);
                        }
                    }).addTo(map);
                }
                
                // 4. Cargar áreas rurales (polígonos)
                const { data: ruralData } = await supabase.from('parr_rural_conali_a').select('*');
                if (ruralData) {
                    capas.parr_rural_conali_a = L.geoJSON(ruralData, {
                        style: { 
                            color: '#8b4513', 
                            fillColor: '#d2b48c', 
                            fillOpacity: 0.4, 
                            weight: 1 
                        }
                    }).addTo(map);
                }
                
                // 5. Cargar áreas urbanas (polígonos)
                const { data: urbanaData } = await supabase.from('parr_urbana_ord002_a').select('*');
                if (urbanaData) {
                    capas.parr_urbana_ord002_a = L.geoJSON(urbanaData, {
                        style: { 
                            color: '#9b59b6', 
                            fillColor: '#8e44ad', 
                            fillOpacity: 0.4, 
                            weight: 1 
                        }
                    }).addTo(map);
                }
                
                // Cargar reportes existentes
                await cargarReportes();
                
                // Configurar eventos de checkboxes
                document.getElementById('ejes-viales').addEventListener('change', (e) => {
                    e.target.checked ? map.addLayer(capas.ejes_viales) : map.removeLayer(capas.ejes_viales);
                });
                
                document.getElementById('parques').addEventListener('change', (e) => {
                    e.target.checked ? map.addLayer(capas.parques) : map.removeLayer(capas.parques);
                });
                
                // ... (similar para otras capas)
                
            } catch (error) {
                console.error("Error cargando capas:", error);
                alert("Error al cargar datos. Ver consola para detalles.");
            }
        }
        
        // ================= REPORTES =================
        async function cargarReportes() {
            const { data, error } = await supabase.from('reportes').select('*');
            if (data) {
                capas.reportes = L.geoJSON(data, {
                    pointToLayer: (feature, latlng) => {
                        return L.circleMarker(latlng, {
                            radius: 8,
                            color: '#e74c3c',
                            fillColor: '#c0392b',
                            className: 'report-marker'
                        }).bindPopup(`
                            <b>Tipo:</b> ${feature.tipo}<br>
                            <b>Descripción:</b> ${feature.descripcion}<br>
                            <small>${new Date(feature.created_at).toLocaleString()}</small>
                        `);
                    }
                }).addTo(map);
            }
        }
        
        async function enviarReporte() {
            const tipo = document.getElementById('tipo-reporte').value;
            const descripcion = document.getElementById('descripcion').value;
            const mensaje = document.getElementById('mensaje-estado');
            
            if (!descripcion) {
                mensaje.textContent = "Por favor ingresa una descripción";
                mensaje.style.color = "red";
                mensaje.style.display = "block";
                return;
            }
            
            try {
                mensaje.textContent = "Enviando reporte...";
                mensaje.style.color = "blue";
                mensaje.style.display = "block";
                
                const { data, error } = await supabase
                    .from('reportes')
                    .insert([{
                        tipo: tipo,
                        descripcion: descripcion,
                        geom: `POINT(${coordenadasActuales.lng} ${coordenadasActuales.lat})`,
                        estado: 'pendiente'
                    }])
                    .select();
                
                if (error) throw error;
                
                mensaje.textContent = "¡Reporte enviado con éxito!";
                mensaje.style.color = "green";
                
                // Actualizar capa de reportes
                if (capas.reportes) map.removeLayer(capas.reportes);
                await cargarReportes();
                
                // Limpiar formulario
                document.getElementById('descripcion').value = '';
                
            } catch (error) {
                console.error("Error enviando reporte:", error);
                mensaje.textContent = "Error al enviar. Intenta nuevamente.";
                mensaje.style.color = "red";
            }
        }
        
        // ================= EVENTOS =================
        function configurarEventos() {
            // Cambio de pestañas
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    btn.classList.add('active');
                    document.getElementById(btn.dataset.tab + '-tab').classList.add('active');
                });
            });
            
            // Click en el mapa para reportar
            map.on('click', function(e) {
                coordenadasActuales = e.latlng;
                document.querySelector('[data-tab="report"]').click();
            });
            
            // Botón de enviar reporte
            document.getElementById('enviar-reporte').addEventListener('click', enviarReporte);
        }
        
        // Iniciar cuando se cargue la página
        window.onload = initMap;
    </script>
</body>
</html>
